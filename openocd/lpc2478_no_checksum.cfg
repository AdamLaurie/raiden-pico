# Custom LPC2478 configuration WITHOUT automatic checksum correction
# Based on standard lpc2478.cfg but with calc_checksum disabled

# Common LPC2xxx setup (inline to avoid calc_checksum)
proc setup_lpc2xxx_no_checksum {chip_name cputapids flash_size flash_variant workarea_size core_freq_khz adapter_freq_khz} {
	reset_config trst_and_srst

	# reset delays
	adapter srst delay 100
	jtag_ntrst_delay 100

	adapter speed $adapter_freq_khz

	foreach i $cputapids {
		append expected_ids "-expected-id " $i " "
	}

	eval "jtag newtap $chip_name cpu -irlen 4 -ircapture 0x1 -irmask 0xf $expected_ids"

	global _TARGETNAME
	set _TARGETNAME $chip_name.cpu
	target create $_TARGETNAME arm7tdmi -chain-position $_TARGETNAME

	$_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size $workarea_size -work-area-backup 0

	if { $flash_size > 0 } {
		# flash bank WITHOUT calc_checksum parameter
		set _FLASHNAME $chip_name.flash
		flash bank $_FLASHNAME lpc2000 0x0 $flash_size 0 0 $_TARGETNAME $flash_variant $core_freq_khz
	}
}

proc setup_lpc2478 {core_freq_khz adapter_freq_khz} {
	# 504kB flash and 64kB SRAM
	# setup_lpc2xxx_no_checksum <chip_name> <cputapid> <flash_size> <flash_variant> <workarea_size> <core_freq_khz> <adapter_freq_khz>
	setup_lpc2xxx_no_checksum lpc2478 0x4f1f0f0f 0x7e000 lpc2000_v2 0x10000 $core_freq_khz $adapter_freq_khz
}

proc init_targets {} {
	# default to core clocked with 4MHz internal oscillator
	echo "Warning - assuming default core clock 4MHz! Flashing may fail if actual core clock is different."
	echo "WARNING - calc_checksum DISABLED - checksums will NOT be auto-corrected!"

	# setup_lpc2478 <core_freq_khz> <adapter_freq_khz>
	setup_lpc2478 4000 500
}
